---
layout:     post
title:      类的加载与初始化
date:      2018-04-14
category:   Java
tags:   [Java]
---

# 类的加载与初始化
### 类的生命周期
加载-->链接-->初始化-->使用-->卸载

### 类的加载时机
类的加载是指把.class文件中的二进制数据读入到内存中，把他放在运行时的数据区的方法区内，
后在堆区创建一个Class的对象，用来封装类在方法区内的数据结构。
### 类的初始化的时机
以下情况一个类被初始化：
- 实例通过使用new()关键字创建或者使用class.forName()反射，但它有可能导致ClassNotFoundException。
- 类的静态方法被调用
- 类的静态域被赋值
- 静态域被访问，而且它不是常量
- 在顶层类中执行assert语句

在初始化之前首先肯定要进行加载。因此有以上情况的时候，类应该已经被加载且初始化完成。
### 类的加载和初始化的过程
1， JVM会先去方法区中找有没有相应类的.class存在。如果有，就直接使用；如果没有，则把相关类的.class加载到方法区

2， 在.class加载到方法区时，会分为两部分加载：先加载非静态内容，再加载静态内容

3， 加载非静态内容：把.class中的所有非静态内容加载到方法区下的非静态区域内

4， 加载静态内容：
- 把.class中的所有静态内容加载到方法区下的静态区域内
- 静态内容加载完成之后，对所有的静态变量进行默认初始化
- 所有的静态变量默认初始化完成之后，再进行显式初始化
- 当静态区域下的所有静态变量显式初始化完后，执行静态代码块

5，当静态区域下的静态代码块，执行完之后，整个类的加载就完成了。

6，如果存在继承关系，则父类先加载，再加载子类。

也就是说，在进行类的初始化之后，类的静态变量已经被赋值完毕了。而非静态变量没有赋值。
### 类的实例化的过程

1， 在堆内存中开辟一块空间

2， 给开辟空间分配一个地址

3， 把对象的所有非静态成员加载到所开辟的空间下

4， 所有的非静态成员加载完成之后，对所有非静态成员变量进行默认初始化

5， 所有非静态成员变量默认初始化完成之后，调用构造函数

6， 在构造函数入栈执行时，分为两部分：先执行构造函数中的隐式三步，再执行构造函数中书写的代码
- 隐式三步：
   - 执行super语句
   - 对开辟空间下的所有非静态成员变量进行显式初始化
   - 执行构造代码块
- 在隐式三步执行完之后，执行构造函数中书写的代码

7，在整个构造函数执行完并弹栈后，把空间分配的地址赋值给一个引用对象

也就是非静态变量的初始化是在类被创建出来的时候进行的。

# 总结
在对一个类的静态属性或者静态方法进行操作而不创建类的实例的时候。
1. 类的所有静态属性都会被赋值
2. 类的static代码快会被执行
3. 上面的操作只会执行一次，也就是在类的初始化的时候。

在创建类的实例是时候
1. 首先判定类是否已经被加载了，如果没有就会执行上面的类的加载和初始化的动作
2. 类的非静态方法进行初始化，非静态代码快被执行，之后才执行构造函数。
3. 上面的操作在每一次创建类的实例的时候都会进行一次。
